# 求人情報自動収集システム - タウンワーク & Indeed

<div align="center">

![Python](https://img.shields.io/badge/Python-3.9%2B-blue?logo=python&logoColor=white)
![PyQt6](https://img.shields.io/badge/PyQt6-GUI-41CD52?logo=qt&logoColor=white)
![Playwright](https://img.shields.io/badge/Playwright-1.40%2B-green?logo=playwright&logoColor=white)
![SQLite](https://img.shields.io/badge/SQLite-Database-003B57?logo=sqlite&logoColor=white)
![License](https://img.shields.io/badge/License-Educational-yellow)

**タウンワーク・Indeedから効率的に求人データを収集するためのデスクトップアプリケーション**

[クイックスタート](#クイックスタート) • [機能](#主な機能) • [使い方](#使い方)

</div>

---

## 更新履歴

### 2025-12-05 - エン転職対応

#### エン転職 (employment.en-japan.com) スクレイピング対応
- **エン転職 スクレイピングに新規対応**
- 職業分類コード検索に対応（100種類以上のカテゴリ）
- 詳細ページから以下の情報を自動取得:
  - 会社名（JSON-LD、セレクター、ページタイトルから取得）
  - 勤務地（「勤務地・交通」セクションから抽出）
  - 給与、雇用形態、仕事内容、応募資格
  - **掲載日**（掲載期間の開始日を抽出）

#### フィルタ機能
- **派遣求人の自動スキップ**: 派遣社員、紹介予定派遣、無期雇用派遣を除外
- **PR記事（広告枠）のスキップ**: 「XX名」「あとX日」で始まる広告記事を除外

#### URL形式対応
- 標準形式: `/desc_XXXXXX/`
- 英語求人形式: `/desc_eng_XXXXXXX/`（キッズドライバー等）

#### 対応職種カテゴリ（一部抜粋）

| 分類 | カテゴリ |
|------|----------|
| 営業 | 営業、法人営業、個人営業、ルートセールス |
| 事務 | 事務、経理、人事、総務、受付 |
| 販売・サービス | 販売、店長、飲食、ホール、調理 |
| IT・Web | SE、エンジニア、プログラマー、Webデザイナー |
| 医療・介護 | 看護師、介護、薬剤師、医療事務 |
| 物流・配送 | ドライバー、配送、倉庫、物流 |
| 教育 | 保育士、講師、インストラクター |

---

### 2025-12-04 - マッハバイト対応 & テストスイート拡充 & 詳細情報取得強化

#### LINEバイト・マッハバイト 詳細情報取得の強化

**LINEバイト**
- **詳細ページから正確な住所を取得**: 「アクセス」→「所在地」セクションから詳細住所を抽出
  - 例: 「大阪市港区磯路中通1-35-6　シッチフィールド磯路ビル3F」
- **派遣求人の自動スキップ**: 雇用形態が「派遣社員」の求人は抽出時に除外
- **雇用形態のCSV出力修正**: employment_typeフィールドが正しくCSVに出力されるよう修正

**マッハバイト**
- **詳細ページから正確な住所を取得**: 「勤務地・面接地」セクションから詳細住所を抽出
  - 都道府県パターンマッチで住所行を正確に特定
  - 例: 「愛知県名古屋市昭和区」
- **最寄駅情報の抽出**: 駅名を含む行を自動的に抽出
- **詳細ページアクセスの追加**: クローリング時に各求人の詳細ページにアクセスして情報取得

---

#### マッハバイト (machbaito.jp) スクレイピング対応
- **マッハバイト スクレイピングに新規対応**
- JIS都道府県コード（1-47）を使用した検索
- 都道府県全域検索用のcityコード対応（47都道府県分）
- **職種カテゴリID自動判別**: キーワードから自動的に職種IDを検出
  - URL形式: `/prefectures{code}/city_{city_code}/jobtag_{id}?q[sk]=1`
  - 例: 東京都全域のエンジニア → `/prefectures13/city_409/jobtag_426?q[sk]=1`
- 100種類以上の職種カテゴリに対応

#### 対応職種カテゴリ（一部抜粋）

| 分類 | カテゴリ |
|------|----------|
| 飲食 | ファミレス, レストラン, 寿司, 焼肉, ラーメン, 居酒屋, カフェ, デリバリー, キッチン, ホール |
| 販売 | 家電, 本屋, 雑貨, アパレル, 携帯, スーパー, レジ, ドラッグストア |
| 美容 | サロン, 美容師, セラピスト, マッサージ, エステ, ネイル |
| オフィス | 受付, 経理, テレアポ, コールセンター, データ入力, 事務, 営業 |
| IT | Web, エンジニア, SE, プログラマー, Webデザイナー, ライター |
| 教育 | 保育園, 保育士, 試験監督, 個別指導, 塾講師, 家庭教師 |
| 医療・介護 | 病院, 看護師, 介護, デイサービス, 訪問介護, ホームヘルパー |
| 物流 | ドライバー, 配送, 倉庫, 引越し, フォークリフト |

#### テストスイート拡充
- **マッハバイト用テスト追加**: マッピングテスト（10項目）、URL生成テスト（9項目）
- 全97テスト PASSED（0.38秒）

---

### 2025-12-03 - LINEバイト対応 & タウンワークURL形式修正

#### LINEバイト (baito.line.me) スクレイピング対応
- **LINEバイト スクレイピングに新規対応**
- React SPA対応の無限スクロール処理を実装
- JIS都道府県コード（1-47）を使用した検索
- **業種カテゴリID自動判別**: キーワードから自動的に業種IDを検出
  - 例: 「テレアポ」→ jobCategoryIds=69、「保育」→ jobCategoryIds=79
- 78種類以上の業種カテゴリに対応

#### 対応業種カテゴリ（一部抜粋）

| 分類 | カテゴリ |
|------|----------|
| 飲食 | カフェ, 居酒屋, ファーストフード, レストラン, ホール, キッチン, ファミレス |
| 販売 | 書店, 雑貨, アパレル, 携帯販売, ドラッグストア, コンビニ, スーパー |
| 医療・介護 | 看護師, 介護, 薬剤師 |
| オフィス | 受付, 事務, コールセンター, テレアポ, 営業 |
| 教育 | 家庭教師, 塾講師, 保育士, 試験監督 |
| 配送 | ドライバー, デリバリー, 引越し |
| 軽作業 | 仕分け, 梱包, 清掃, 警備 |
| イベント | イベントスタッフ, サンプリング |
| 美容 | 美容師, エステ, マッサージ |

#### タウンワーク URL形式の修正
- **旧形式（廃止）**: `https://townwork.net/prefectures/{area}/job_search/oc-xxx/`
- **新形式**: `https://townwork.net/job_search/kw/{エリア}+{キーワード}/`
- 400エラーが発生していた問題を解決

#### タウンワーク エラーハンドリング強化
- セッション確立機能の追加（トップページ訪問によるCookie取得）
- リトライ回数を2回→3回に増加
- 各エラータイプに応じた待機時間の最適化

#### LINEバイト 職種名抽出の改善
- 説明文ではなく職種名（例: 「保育スタッフ」）を正しく取得するよう修正
- 長い説明文と短い職種名を自動判別

---

### 2025-12-02 - フィルタ改善 & 新規件数カウント修正

#### 業界フィルタの改善
- **広告・メディアフィルタの精度向上**: 事業内容に「広告」が含まれるだけで除外されないよう改善
  - 変更前: 「広告」「メディア」などの曖昧なキーワードで判定
  - 変更後: 「広告代理店」「広告業」「放送局」など具体的な業態名で判定
- **チェック対象を限定**: 会社名のみをチェック対象とし、事業内容はチェック対象外に
  - 例: 保育施設で「広告チラシの配布」と記載があっても除外されなくなった

#### 新規件数カウントの修正
- **正確な新規件数算出**: DBへの保存結果に基づいて新規/既存を正確に判定
  - 変更前: 保存前に別ロジックでチェックしていたため、不整合が発生
  - 変更後: `save_job`の戻り値で新規挿入か更新かを判定
- **全サイト対応**: タウンワーク、Indeed、バイトル、ハローワークすべてで修正

#### ハローワーク検索の修正
- **職業分類コードの修正**: 中分類コード（3桁）を使用するよう修正
  - 変更前: 大分類コード（2桁）を使用していたため、異なるカテゴリの求人が表示されていた
  - 変更後: 正しい中分類コードで検索（例: 保育→029、営業→048）

---

### 2025-12-01 (v2) - GUI進捗表示の改善

#### 進捗表示の大幅改善
- **リアルタイム詳細取得進捗**: 「詳細取得中... 25/150件（全150件中）」形式でリアルタイム表示
- **一覧取得完了表示**: 一覧取得が完了した時点で「一覧取得完了: X件」を表示
- **完了時の緑テロップ削除**: 重複情報を整理し、シンプルな表示に変更
- **所要時間の統合表示**: 完了時に「今回の新規取得：X件（抽出：Y件 / 所要時間）」形式で表示

#### 表示フローの改善
1. 開始時: `抽出中... 0 件取得済み`（青枠）
2. 一覧取得完了時: `一覧取得完了: 150 件（2分30秒）`（青枠）
3. 詳細取得中: `詳細取得中... 25/150 件（全150件中）`（青枠）- リアルタイム更新
4. 完了時: `今回の新規取得：50 件（抽出：150 件 / 5分30秒）`（緑枠/灰枠）

---

### 2025-12-01 - バイトル対応 & GUI機能強化

#### バイトル (baitoru.com) スクレイピング対応
- **バイトル Japan スクレイピングに対応**
- カテゴリ別検索（80種類のカテゴリに対応）
- 新着順ソート（srt2パラメータ）に対応
- タウンワークと同様のデータ項目を取得
- **高速化対応**: 画像・動画のブロック、並列2詳細取得で処理速度約2倍

#### GUI機能強化
- **最終クローリング日時表示**: 左パネルに「最終クローリング日時：YYYY/MM/DD HH:MM」を表示
- **新規取得件数の強調表示**: 「今回の新規取得：X件（抽出：Y件）」形式で目立つ表示
  - 新規1件以上：緑色、0件：灰色で視覚的に判別
- **分析タブ追加**: 右パネルに「分析」タブを新設
  - 過去n回のクローリング結果を棒グラフで可視化
  - 実行回ごとの新規取得件数推移を表示
  - 累計・平均・最大のサマリー表示

#### フィルタ機能強化
- **「50」で始まる電話番号を除外対象に追加**: IP電話（先頭0なしパターン）を除外

#### 対応カテゴリ（80種類）

| 分類 | カテゴリ |
|------|----------|
| 飲食 | 販売, フード, 飲食, レストラン, カフェ, バー, 居酒屋, ファストフード, キッチン, 調理, バーテンダー, パティシエ |
| オフィス | オフィス, 事務, コールセンター, 経理, 秘書, 受付, インフォメーション |
| 物流・工場 | 工場, 製造, 配達, 配送, ピッキング, 梱包, 仕分け, 軽作業, フォークリフト, 引越し |
| サービス | 警備, サービス, 接客, ホテル |
| 美容 | 美容, 理容, 理容師, 清掃 |
| ドライバー | ドライバー, 運転 |
| レジャー | イベント, カラオケ, ゲーム, プール, ジム, フィットネス, ボウリング, 映画館, 劇場 |
| 教育 | 教育, 塾, スクール, 家庭教師, 保育 |
| 医療・介護 | 病院, 医療, 看護, 看護師, 薬剤師, デイサービス, グループホーム, 老人ホーム, 介護 |
| クリエイティブ | デザイン, クリエイティブ, Webデザイナー, Webデザイン, プログラマー, 編集, 通訳 |
| 専門職 | マーケティング, 整備士, 建築, コンサルタント, セラピスト, マッサージ, モデル, 音楽 |
| その他 | ナイトワーク, プロフェッショナル, 専門 |

#### コマンドラインからの実行
```bash
# 販売カテゴリで検索
python run_baitoru.py --category 販売 --pages 3

# 警備カテゴリで検索
python run_baitoru.py --category 警備 --pages 2

# 利用可能なカテゴリ一覧を表示
python run_baitoru.py --list-categories
```

---

### 2025-11-28 - 大型アップデート

#### Indeed対応
- **Indeed Japan (jp.indeed.com) スクレイピングに対応**(調整中） 
- タウンワークと同様に都道府県 × 職種での検索が可能
- GUI上でタウンワーク/Indeedを選択して同時検索可能

#### 詳細情報取得機能
- **タウンワークの詳細ページから以下の情報を自動取得**:
  - 住所
  - 電話番号
  - 事業内容
  - 仕事内容
  - 掲載日
- **並列処理による高速化**: 最大3並列で詳細ページを取得
- **重複スキップ**: 同一求人ID（job_id）の詳細取得をスキップして効率化

#### カテゴリコードの修正
- **タウンワークの職種カテゴリコードを全面的に修正**
- 以前の設定では「営業」を選択すると「レジャー」カテゴリが検索されるバグがあった
- 正しいカテゴリコード（oc-XXX）とサブカテゴリコード（omc-XXXX）にマッピング

**修正された主なカテゴリ:**

| キーワード | 旧設定（誤り） | 新設定（正しい） |
|------------|----------------|------------------|
| 営業 | oc-003/ (レジャー) | oc-002/omc-0011/ (営業) |
| IT | oc-001/ (飲食) | oc-013/ (IT・Web・ゲームエンジニア) |
| 事務 | oc-002/ (営業・販売) | oc-006/ (経営・事業企画・人事・事務) |
| 製造 | oc-005/ (警備) | oc-019/ (製造・工場) |

---

## 目次

- [クイックスタート](#クイックスタート)
- [重要な注意事項](#重要な注意事項)
- [主な機能](#主な機能)
- [セットアップ](#セットアップ)
- [使い方](#使い方)
- [プロジェクト構造](#プロジェクト構造)
- [トラブルシューティング](#トラブルシューティング)
- [今後の開発](#今後の開発)
- [ライセンス](#ライセンス)

---

## クイックスタート

### 簡単起動（Windows）- 推奨

**初回セットアップ手順:**

1. `setup.bat` をダブルクリック → セットアップ完了まで待つ
2. `start.bat` をダブルクリック → アプリが起動！

**2回目以降:**

`start.bat` をダブルクリックするだけ！

> **注意**: Pythonがインストールされていない場合は、自動的にPython 3.11をダウンロード・インストールします。インストール後は一度ウィンドウを閉じて、再度バッチファイルを実行してください。

### バッチファイル一覧

| ファイル | 用途 | 説明 |
|----------|------|------|
| `setup.bat` | **初回必須** | Python確認 + 依存パッケージ + Playwrightブラウザをインストール |
| `start.bat` | アプリ起動 | アプリケーションを起動 |

### コマンドラインから起動

```bash
# 1. 依存パッケージのインストール
pip install playwright pandas openpyxl PyQt6 APScheduler beautifulsoup4 lxml aiofiles python-dotenv pydantic

# 2. Playwrightブラウザのインストール
playwright install chromium

# 3. アプリケーション起動
python main.py
```

PyQt6ベースのデスクトップGUIが起動します。

---

## 重要な注意事項

> **警告**: このシステムは**技術検証・学習目的**で開発されています。

| ルール | 詳細 |
|--------|------|
| 利用規約 | 各サイトの利用規約を必ず確認してください |
| 商用利用 | 避けてください |
| アクセス頻度 | 適切に制限してください |
| robots.txt | 尊重してください |

---

## 主な機能

### 対応サイト

| サイト | 対応状況 | 備考 |
|--------|----------|------|
| タウンワーク | ✅ 対応 | キーワード検索形式（/job_search/kw/）に対応 |
| Indeed Japan | ✅ 対応 | ボット検出対策のため headed モードで動作 |
| バイトル | ✅ 対応 | 80種類のカテゴリに対応、コマンドライン実行 |
| ハローワーク | ✅ 対応 | 職業分類コード検索、並列3処理に対応 |
| LINEバイト | ✅ 対応 | React SPA対応、78種類の業種カテゴリ自動判別 |
| マッハバイト | ✅ 対応 | JIS都道府県コード、100種類以上の職種カテゴリ対応 |
| エン転職 | ✅ 対応 | 派遣・PR記事自動除外、掲載日抽出対応 |

### 検索機能

| 機能 | 説明 |
|------|------|
| **地域選択** | 47都道府県から選択可能、地方単位での一括選択に対応 |
| **キーワード検索** | IT、事務、営業など40種類以上のプリセットキーワード |
| **カスタムキーワード** | 任意のキーワードを追加可能 |
| **並列処理** | 非同期処理による高速スクレイピング（1〜12並列） |
| **サイト選択** | タウンワーク / Indeed を選択して検索 |

### 取得データ項目

#### 一覧ページから取得
- 会社名
- 職種
- 勤務地
- 給与
- 雇用形態
- 求人ページURL

#### 詳細ページから取得（タウンワーク）
- 住所
- 電話番号
- 事業内容
- 仕事内容
- 掲載日
- 郵便番号
- 勤務時間
- 休日休暇

### フィルタ機能

| フィルタ | 説明 |
|----------|------|
| **電話番号重複削除** | 同一電話番号の求人を1件に集約 |
| **大企業除外** | 従業員数1,001人以上の企業を除外（しきい値変更可能） |
| **派遣・紹介除外** | 人材派遣、人材紹介等を含む企業を除外 |
| **業界フィルタ** | 広告、メディア、出版業界を除外 |
| **勤務地フィルタ** | 沖縄県の求人を除外 |
| **電話番号プレフィックス** | 0120、050、沖縄局番等を除外 |

### データ管理

| 機能 | 説明 |
|------|------|
| **SQLiteデータベース** | 取得した求人データを永続化 |
| **重複検出** | URL・求人IDによる重複排除 |
| **CSVエクスポート** | フィルタ前・後のデータをCSV出力（UTF-8 BOM付き） |
| **統計表示** | DB累計件数、新着件数、DBサイズを表示 |

### 技術的特徴

- **PyQt6 GUI** - ネイティブなデスクトップアプリケーション
- **Playwright** - 高速で安定したブラウザ自動化
- **Stealth設定** - ヘッドレスブラウザ検出回避
- **非同期処理** - UIをブロックせずにバックグラウンド実行
- **リアルタイム進捗** - 経過時間、取得件数、保存件数をリアルタイム表示
- **並列詳細取得** - セマフォで同時接続数を制限しつつ並列処理

---

## セットアップ

### 必要要件

- Python 3.9以上
- Windows / macOS / Linux

### インストール

```bash
# 1. 依存パッケージのインストール
pip install -r requirements.txt

# 2. Playwrightブラウザのインストール
playwright install chromium

# 3. セットアップ検証（オプション）
python verify_setup.py
```

---

## 使い方

### アプリケーション起動

#### バッチファイルで起動（推奨・Windows）

ターミナル操作不要で、ダブルクリックだけで起動できます。

| ファイル | 用途 | 説明 |
|----------|------|------|
| `setup.bat` | 初回セットアップ | Python環境の確認、依存パッケージとPlaywrightブラウザのインストール |
| `start.bat` | アプリ起動 | アプリケーションを起動（未セットアップの場合は自動でセットアップ） |

**手順:**
1. 初回は `setup.bat` をダブルクリックしてセットアップ
2. 以降は `start.bat` をダブルクリックするだけ

#### コマンドラインで起動

```bash
python main.py
```

### 画面構成

アプリケーションは左右2パネル構成です：

**左パネル（設定）**
- **地域選択タブ**: 都道府県を選択（地方単位での一括選択可能）
- **キーワードタブ**: 検索キーワードを選択（カスタムキーワード追加可能）
- **フィルタ・オプションタブ**: フィルタ設定と検索オプション
  - **媒体選択**: タウンワーク / Indeed / バイトル のチェックボックス
- **今回の新規取得件数**: クローリング結果を目立つ形式で表示
- **最終クローリング日時**: 直近のクローリング実行日時を表示

**右パネル（結果）**
- **検索結果タブ**: 取得した求人一覧
- **フィルタ結果タブ**: フィルタ適用後の求人一覧
- **分析タブ**: 過去のクローリング結果を棒グラフで可視化

### 基本的な操作手順

1. **地域を選択**: 左パネルの「地域選択」タブで都道府県を選択
2. **キーワードを選択**: 「キーワード」タブで検索キーワードを選択
3. **媒体を選択**: 「フィルタ・オプション」タブでタウンワーク/Indeedを選択
4. **検索実行**: 「検索実行」ボタンをクリック
5. **フィルタ適用**: 検索結果タブで「フィルタ適用」ボタンをクリック
6. **CSVエクスポート**: 必要に応じてCSV出力

### 検索オプション

| オプション | 説明 | デフォルト |
|------------|------|------------|
| 最大ページ数 | 各検索条件で取得するページ数 | 5 |
| 並列数 | 同時に処理する数 | 5 |

---

## プロジェクト構造

```
scraping/
├── main.py                      # エントリーポイント（GUIを起動）
├── requirements.txt             # 依存パッケージ
│
├── src/                         # メインソースコード
│   ├── gui/
│   │   ├── main_window.py       # PyQt6メインウィンドウ
│   │   └── styles.py            # UIスタイル定義
│   │
│   ├── services/
│   │   ├── crawl_service.py     # クローリングサービス
│   │   └── csv_exporter.py      # CSVエクスポート
│   │
│   ├── database/
│   │   ├── db_manager.py        # データベース管理
│   │   └── job_repository.py    # 求人データリポジトリ
│   │
│   ├── filters/
│   │   └── job_filter.py        # フィルタ処理
│   │
│   └── models/
│       ├── job.py               # 求人モデル
│       └── search_condition.py  # 検索条件モデル
│
├── scrapers/
│   ├── townwork.py              # タウンワークスクレイパー
│   ├── indeed.py                # Indeedスクレイパー
│   ├── baitoru.py               # バイトルスクレイパー
│   ├── hellowork.py             # ハローワークスクレイパー
│   ├── linebaito.py             # LINEバイトスクレイパー
│   ├── machbaito.py             # マッハバイトスクレイパー
│   ├── entenshoku.py            # エン転職スクレイパー
│   └── base_scraper.py          # ベーススクレイパー
│
├── config/
│   └── selectors.json           # サイト別セレクタ・カテゴリコード設定
│
├── utils/
│   ├── stealth.py               # ステルス設定
│   ├── page_utils.py            # ページユーティリティ
│   └── ...                      # その他ユーティリティ
│
└── data/
    ├── db/                      # SQLiteデータベース
    └── output/                  # CSVエクスポート先
```

---

## トラブルシューティング

### バッチファイルをダブルクリックしても一瞬で消える

**原因**: Pythonや依存パッケージが正しくインストールされていない可能性があります。

**解決方法**:
1. まず `setup.bat` をダブルクリックしてセットアップを実行
2. セットアップ完了後、`start.bat` をダブルクリック

### アプリが起動しない

```bash
# PyQt6がインストールされているか確認
pip show PyQt6

# 再インストール
pip install --upgrade PyQt6
```

**または `setup.bat` を再実行してください。**

### データが取得できない

1. **ネットワーク接続を確認**
2. **並列数を減らす**: フィルタ・オプションタブで並列数を1〜3に設定
3. **ヘッドレスモード無効化**: `scrapers/townwork.py`の`headless=False`に変更してブラウザ動作を確認

### Indeed で 0件になる

- Indeedはボット検出が厳しいため、headed モード（ブラウザ表示）で動作します
- 検索条件を絞って再試行してください
- 連続アクセスを避け、時間を空けてください

### Playwrightエラー

```bash
# ブラウザを再インストール
playwright install chromium --with-deps
```

### CSVが文字化けする

- CSVはUTF-8 BOM付きで出力されます
- Excelで開く場合は通常そのまま開けます
- 文字化けする場合は「データ」→「テキストから」でUTF-8を指定

---

## 今後の開発

- [x] Indeed対応
- [x] 詳細ページからの情報取得
- [x] カテゴリコードの修正
- [ ] エラーリトライ機能の強化
- [ ] スケジューラー機能（定期実行）
- [ ] 詳細ログビューア
- [x] その他求人サイト対応（バイトル）

---

## ライセンス

このプロジェクトは**教育・研究目的**でのみ使用してください。

商用利用は禁止されています。

---

<div align="center">

**最終更新**: 2025-12-05

---

Made with PyQt6 + Playwright + SQLite

</div>
